{
  "outputId": "2026_01_28_001_theme_engine_global_refactor",
  "taskPrompt": "Refatorar o Theme Engine de 'tema por projeto' para 'tema global da aplicação'. Um único tema ativo controla toda a interface do Gatekeeper. Remover relação Theme-Project, atualizar rotas para /themes, e simplificar frontend.",
  "manifest": {
    "testFile": "packages/gatekeeper-api/tests/theme/theme-engine-global.spec.ts",
    "files": [
      {
        "path": "packages/gatekeeper-api/tests/theme/theme-engine-global.spec.ts",
        "action": "CREATE",
        "reason": "Testes para validar a refatoração do Theme Engine para tema global"
      },
      {
        "path": "packages/gatekeeper-api/prisma/schema.prisma",
        "action": "MODIFY",
        "reason": "Remover projectId do model Theme, remover relação com Project, adicionar @@unique([name])"
      },
      {
        "path": "packages/gatekeeper-api/prisma/migrations/20260128_theme_global_refactor/migration.sql",
        "action": "CREATE",
        "reason": "Migration para dropar e recriar tabela Theme sem projectId"
      },
      {
        "path": "packages/gatekeeper-api/src/repositories/ThemeRepository.ts",
        "action": "MODIFY",
        "reason": "Refatorar métodos: findAll(), findActive() sem projectId, activate() global, deactivateAll()"
      },
      {
        "path": "packages/gatekeeper-api/src/types/theme.types.ts",
        "action": "MODIFY",
        "reason": "Remover projectId de CreateThemeData"
      },
      {
        "path": "packages/gatekeeper-api/src/api/controllers/ThemeController.ts",
        "action": "MODIFY",
        "reason": "Remover extração de projectId, remover validação de projeto, simplificar métodos"
      },
      {
        "path": "packages/gatekeeper-api/src/api/routes/theme.routes.ts",
        "action": "MODIFY",
        "reason": "Atualizar paths de /projects/:projectId/themes para /themes"
      },
      {
        "path": "src/lib/types.ts",
        "action": "MODIFY",
        "reason": "Remover projectId das interfaces Theme e ThemeDetailed"
      },
      {
        "path": "src/lib/api.ts",
        "action": "MODIFY",
        "reason": "Atualizar métodos theme.* para não receber projectId e usar novas URLs"
      },
      {
        "path": "src/hooks/use-active-theme.ts",
        "action": "MODIFY",
        "reason": "Remover parâmetro projectId, carregar tema global no mount"
      },
      {
        "path": "src/components/theme-settings-page.tsx",
        "action": "MODIFY",
        "reason": "Remover prop projectId, simplificar handlers para chamadas sem projectId"
      },
      {
        "path": "src/App.tsx",
        "action": "MODIFY",
        "reason": "Remover projectId='default' da rota /settings/theme"
      }
    ]
  },
  "contract": {
    "schemaVersion": "1.0",
    "slug": "theme-engine-global-refactor",
    "title": "Refatoração do Theme Engine para Tema Global",
    "mode": "STRICT",
    "changeType": "refactor",
    "criticality": "high",
    "clauses": [
      {
        "id": "CL-SCHEMA-001",
        "kind": "behavior",
        "normativity": "MUST",
        "when": "O schema Prisma é carregado",
        "then": "O model Theme NÃO possui campo projectId nem relação com Project"
      },
      {
        "id": "CL-SCHEMA-002",
        "kind": "constraint",
        "normativity": "MUST",
        "when": "Tentativa de criar tema com nome duplicado",
        "then": "Erro de constraint violation é lançado devido a @@unique([name])"
      },
      {
        "id": "CL-SCHEMA-003",
        "kind": "behavior",
        "normativity": "MUST",
        "when": "O schema Prisma é carregado",
        "then": "O model Project NÃO possui campo themes Theme[]"
      },
      {
        "id": "CL-REPO-001",
        "kind": "behavior",
        "normativity": "MUST",
        "when": "findAll() é chamado",
        "then": "Retorna todos os temas ordenados por createdAt desc sem filtro de projectId"
      },
      {
        "id": "CL-REPO-002",
        "kind": "behavior",
        "normativity": "MUST",
        "when": "findActive() é chamado sem parâmetros",
        "then": "Retorna o único tema com isActive: true ou null"
      },
      {
        "id": "CL-REPO-003",
        "kind": "behavior",
        "normativity": "MUST",
        "when": "create(data) é chamado",
        "then": "Cria tema sem campo projectId no data"
      },
      {
        "id": "CL-REPO-004",
        "kind": "behavior",
        "normativity": "MUST",
        "when": "activate(themeId) é chamado",
        "then": "Desativa TODOS os outros temas e ativa o especificado em transação"
      },
      {
        "id": "CL-REPO-005",
        "kind": "behavior",
        "normativity": "MUST",
        "when": "deactivateAll() é chamado",
        "then": "Define isActive: false para todos os temas"
      },
      {
        "id": "CL-CTRL-001",
        "kind": "behavior",
        "normativity": "MUST",
        "when": "GET /themes é chamado",
        "then": "Retorna status 200 com lista de todos os temas"
      },
      {
        "id": "CL-CTRL-002",
        "kind": "behavior",
        "normativity": "MUST",
        "when": "POST /themes com preset válido",
        "then": "Retorna status 201 com tema criado sem projectId no response"
      },
      {
        "id": "CL-CTRL-003",
        "kind": "behavior",
        "normativity": "MUST",
        "when": "GET /themes/active é chamado",
        "then": "Retorna status 200 com tema ativo global ou 404 se nenhum"
      },
      {
        "id": "CL-CTRL-004",
        "kind": "behavior",
        "normativity": "MUST",
        "when": "PUT /themes/:themeId/activate é chamado",
        "then": "Retorna status 200 e ativa tema sem validar projeto"
      },
      {
        "id": "CL-CTRL-005",
        "kind": "behavior",
        "normativity": "MUST",
        "when": "DELETE /themes/:themeId para tema inativo",
        "then": "Retorna status 204 sem validar projeto"
      },
      {
        "id": "CL-CTRL-006",
        "kind": "error",
        "normativity": "MUST",
        "when": "DELETE /themes/:themeId para tema ativo",
        "then": "Retorna status 400 com error.code CANNOT_DELETE_ACTIVE_THEME"
      },
      {
        "id": "CL-ROUTE-001",
        "kind": "behavior",
        "normativity": "MUST",
        "when": "Rotas de theme são registradas",
        "then": "Usam paths sem :projectId: POST/GET /themes, GET /themes/active, PUT/DELETE /themes/:themeId"
      },
      {
        "id": "CL-TYPE-001",
        "kind": "behavior",
        "normativity": "MUST",
        "when": "Interface Theme em types.ts é analisada",
        "then": "Campo projectId está ausente"
      },
      {
        "id": "CL-API-001",
        "kind": "behavior",
        "normativity": "MUST",
        "when": "api.theme.list() é chamado",
        "then": "Não recebe parâmetros e chama GET /themes"
      },
      {
        "id": "CL-API-002",
        "kind": "behavior",
        "normativity": "MUST",
        "when": "api.theme.getActive() é chamado",
        "then": "Não recebe parâmetros e chama GET /themes/active"
      },
      {
        "id": "CL-API-003",
        "kind": "behavior",
        "normativity": "MUST",
        "when": "api.theme.create(preset) é chamado",
        "then": "Não recebe projectId e chama POST /themes"
      },
      {
        "id": "CL-API-004",
        "kind": "behavior",
        "normativity": "MUST",
        "when": "api.theme.activate(themeId) é chamado",
        "then": "Não recebe projectId e chama PUT /themes/:themeId/activate"
      },
      {
        "id": "CL-API-005",
        "kind": "behavior",
        "normativity": "MUST",
        "when": "api.theme.delete(themeId) é chamado",
        "then": "Não recebe projectId e chama DELETE /themes/:themeId"
      },
      {
        "id": "CL-HOOK-001",
        "kind": "behavior",
        "normativity": "MUST",
        "when": "useActiveTheme() é chamado",
        "then": "Não recebe parâmetros e carrega tema global no mount"
      },
      {
        "id": "CL-PAGE-001",
        "kind": "behavior",
        "normativity": "MUST",
        "when": "ThemeSettingsPage é renderizado",
        "then": "Não recebe prop projectId"
      },
      {
        "id": "CL-PAGE-002",
        "kind": "behavior",
        "normativity": "MUST",
        "when": "ThemeSettingsPage monta",
        "then": "Chama api.theme.list() sem parâmetros"
      },
      {
        "id": "CL-PAGE-003",
        "kind": "behavior",
        "normativity": "MUST",
        "when": "handleApply é executado",
        "then": "Chama api.theme.create(preset) sem projectId"
      },
      {
        "id": "CL-PAGE-004",
        "kind": "behavior",
        "normativity": "MUST",
        "when": "handleActivate é executado",
        "then": "Chama api.theme.activate(themeId) sem projectId"
      },
      {
        "id": "CL-PAGE-005",
        "kind": "behavior",
        "normativity": "MUST",
        "when": "handleDelete é executado",
        "then": "Chama api.theme.delete(themeId) sem projectId"
      },
      {
        "id": "CL-APP-001",
        "kind": "behavior",
        "normativity": "MUST",
        "when": "Rota /settings/theme é renderizada",
        "then": "ThemeSettingsPage é renderizado sem props"
      },
      {
        "id": "CL-BTYPE-001",
        "kind": "behavior",
        "normativity": "MUST",
        "when": "CreateThemeData em theme.types.ts é analisada",
        "then": "Campo projectId está ausente"
      }
    ],
    "assertionSurface": {
      "http": {
        "methods": ["GET", "POST", "PUT", "DELETE"],
        "routes": [
          "/api/themes",
          "/api/themes/active",
          "/api/themes/:themeId/activate",
          "/api/themes/:themeId",
          "/api/themes/preview"
        ],
        "successStatuses": [200, 201, 204],
        "errorStatuses": [400, 404, 500]
      },
      "payloadPaths": [
        "themes",
        "themes[].id",
        "themes[].name",
        "themes[].version",
        "themes[].isActive",
        "themes[].createdAt",
        "id",
        "name",
        "version",
        "isActive",
        "createdAt",
        "cssVariables",
        "layoutConfig",
        "componentStyles",
        "error.code",
        "error.message"
      ],
      "errorCodes": [
        "THEME_NOT_FOUND",
        "INVALID_PRESET",
        "CANNOT_DELETE_ACTIVE_THEME",
        "INTERNAL_ERROR",
        "DUPLICATE_THEME_NAME"
      ],
      "ui": {
        "routes": ["/settings/theme"],
        "testIds": ["theme-settings-page"],
        "roles": [],
        "ariaLabels": []
      },
      "effects": [
        "db:Theme.create",
        "db:Theme.update",
        "db:Theme.delete",
        "db:Theme.findMany",
        "db:Theme.findFirst"
      ]
    },
    "testMapping": {
      "tagPattern": "// @clause",
      "allowMultiple": true,
      "allowUntagged": false
    }
  },
  "baseRef": "origin/main",
  "targetRef": "HEAD",
  "dangerMode": true,
  "dangerModeJustification": "Migration necessária para refatoração arquitetural: remover coluna projectId da tabela Theme e adicionar constraint unique em name. Esta é uma breaking change intencional que requer drop/recreate da tabela.",
  "runType": "CONTRACT"
}
