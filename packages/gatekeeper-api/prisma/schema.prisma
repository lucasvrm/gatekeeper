generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Workspace {
  id           String   @id @default(cuid())
  name         String   @unique
  description  String?
  rootPath     String
  artifactsDir String   @default("artifacts")
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  projects           Project[]
  workspaceConfigs   WorkspaceConfig[]
  testPathConventions TestPathConvention[]

  @@index([isActive])
}

model Project {
  id               String   @id @default(cuid())
  workspaceId      String
  workspace        Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  name             String
  description      String?
  baseRef          String   @default("origin/main")
  targetRef        String   @default("HEAD")
  backendWorkspace String?
  isActive         Boolean  @default(true)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  validationRuns ValidationRun[]

  @@unique([workspaceId, name])
  @@index([workspaceId])
  @@index([isActive])
}

model WorkspaceConfig {
  id          String   @id @default(cuid())
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  key         String
  value       String
  type        String   @default("STRING")
  category    String
  description String?
  updatedAt   DateTime @updatedAt

  @@unique([workspaceId, key])
  @@index([workspaceId])
}

model ValidationRun {
  id              String   @id @default(cuid())
  projectId       String?
  project         Project? @relation(fields: [projectId], references: [id], onDelete: SetNull)
  outputId        String
  projectPath     String
  baseRef         String   @default("origin/main")
  targetRef       String   @default("HEAD")
  taskPrompt      String
  manifestJson    String
  testFilePath    String
  dangerMode      Boolean  @default(false)
  runType         String   @default("CONTRACT")
  contractRunId   String?
  contractRun     ValidationRun?  @relation("ExecutionToContract", fields: [contractRunId], references: [id])
  contractJson    String?
  commitHash      String?
  commitMessage   String?
  committedAt     DateTime?
  bypassedValidators String?
  executionRuns   ValidationRun[] @relation("ExecutionToContract")
  status          String   @default("PENDING")
  currentGate     Int      @default(0)
  passed          Boolean  @default(false)
  failedAt        Int?
  failedValidatorCode String?
  summary         String?
  startedAt       DateTime?
  completedAt     DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  gateResults      GateResult[]
  validatorResults ValidatorResult[]
  logs             ValidationLog[]
  manifestFiles    ManifestFile[]

  @@index([projectId])
  @@index([status])
  @@index([createdAt])
  @@index([projectPath])
  @@index([outputId])
}

model GateResult {
  id              String    @id @default(cuid())
  runId           String
  run             ValidationRun @relation(fields: [runId], references: [id], onDelete: Cascade)
  gateNumber      Int
  gateName        String
  status          String    @default("PENDING")
  passed          Boolean   @default(false)
  totalValidators Int       @default(0)
  passedCount     Int       @default(0)
  failedCount     Int       @default(0)
  warningCount    Int       @default(0)
  skippedCount    Int       @default(0)
  startedAt       DateTime?
  completedAt     DateTime?
  durationMs      Int?
  createdAt       DateTime  @default(now())

  @@unique([runId, gateNumber])
  @@index([gateNumber])
  @@index([status])
}

model ValidatorResult {
  id             String    @id @default(cuid())
  runId          String
  run            ValidationRun @relation(fields: [runId], references: [id], onDelete: Cascade)
  gateNumber     Int
  validatorCode  String
  validatorName  String
  validatorOrder Int
  status         String    @default("PENDING")
  passed         Boolean   @default(false)
  isHardBlock    Boolean   @default(true)
  bypassed       Boolean   @default(false)
  message        String?
  details        String?
  evidence       String?
  metrics        String?
  startedAt      DateTime?
  completedAt    DateTime?
  durationMs     Int?
  createdAt      DateTime  @default(now())

  @@unique([runId, validatorCode])
  @@index([gateNumber])
  @@index([validatorCode])
  @@index([status])
}

model ValidationLog {
  id         String   @id @default(cuid())
  runId      String
  run        ValidationRun @relation(fields: [runId], references: [id], onDelete: Cascade)
  level      String
  source     String
  message    String
  gateNumber Int?
  validator  String?
  metadata   String?
  stackTrace String?
  timestamp  DateTime @default(now())

  @@index([runId])
  @@index([level])
  @@index([timestamp])
}

model ManifestFile {
  id          String   @id @default(cuid())
  runId       String
  run         ValidationRun @relation(fields: [runId], references: [id], onDelete: Cascade)
  filePath    String
  action      String
  reason      String?
  wasModified Boolean  @default(false)
  inDiff      Boolean  @default(false)
  createdAt   DateTime @default(now())

  @@unique([runId, filePath])
  @@index([runId])
}

model SensitiveFileRule {
  id          String   @id @default(cuid())
  pattern     String   @unique
  category    String
  severity    String   @default("BLOCK")
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model AmbiguousTerm {
  id         String   @id @default(cuid())
  term       String   @unique
  category   String
  suggestion String?
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
}

model ValidationConfig {
  id          String   @id @default(cuid())
  key         String   @unique
  value       String
  type        String   @default("NUMBER")
  category    String
  description String?
  failMode    String?
  updatedAt   DateTime @updatedAt
}

model TestPathConvention {
  id          String     @id @default(cuid())
  workspaceId String     @default("__global__")
  workspace   Workspace? @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  testType    String
  pathPattern String
  description String?
  isActive    Boolean    @default(true)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  @@unique([workspaceId, testType])
  @@index([workspaceId])
}

model ValidatorMetadata {
  id          String   @id @default(cuid())
  code        String   @unique
  displayName String
  description String
  category    String
  gate        Int
  order       Int
  isHardBlock Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([category])
  @@index([gate])
}

// =============================================================================
// MCP SESSION MODELS
// =============================================================================

model Snippet {
  id        String   @id @default(cuid())
  name      String   @unique
  category  String   @default("OTHER")
  content   String
  tags      String   @default("[]")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([category])
  @@index([name])
}

model ContextPack {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  files       String   @default("[]")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([name])
}

model SessionPreset {
  id        String   @id @default(cuid())
  name      String   @unique
  config    String   @default("{}")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([name])
}

model SessionHistory {
  id          String   @id @default(cuid())
  taskType    String
  gitStrategy String
  branch      String?
  projectId   String?
  status      String   @default("COMPLETED")
  runIds      String   @default("[]")
  notes       String?
  createdAt   DateTime @default(now())

  @@index([status])
  @@index([createdAt])
}

model MCPSessionConfig {
  id        String   @id @default("singleton")
  config    String   @default("{}")
  updatedAt DateTime @updatedAt
}

model PromptInstruction {
  id        String   @id @default(cuid())
  name      String   @unique
  content   String
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
